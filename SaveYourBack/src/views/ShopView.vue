<template>
	<div class="shop_container">
		<div class="shop_icon_container">
			<img
				class="shop_icon"
				src="../assets/shop_icon.svg"
				alt="Иконка магазина"
			/>
			<div class="money_container">
				<svg
					id="svg"
					fill="#fff"
					stroke="#fff"
					width="28px"
					height="28px"
					version="1.1"
					viewBox="144 144 512 512"
					xmlns="http://www.w3.org/2000/svg"
				>
					<g id="IconSvg_bgCarrier" stroke-width="0"></g>
					<g
						id="IconSvg_tracerCarrier"
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke="#fff"
					></g>
					<g id="IconSvg_iconCarrier">
						<g xmlns="http://www.w3.org/2000/svg">
							<path
								d="m345.53 287.35c-67.172 32.676-118.72 119.64-118.72 191.37 0 101.55 61.504 157.44 173.18 157.44 111.68 0 173.18-55.891 173.18-157.44 0-71.723-51.547-158.69-118.72-191.37 46.301-7.7383 71.488-34.102 71.488-76.281-0.007813-13.617-5.8906-26.566-16.141-35.531-10.254-8.9609-23.875-13.062-37.371-11.254-13.492 1.8125-25.551 9.3594-33.078 20.703-8.75-13.191-23.531-21.121-39.359-21.121-15.832 0-30.609 7.9297-39.363 21.121-7.5234-11.344-19.582-18.891-33.078-20.703-13.496-1.8086-27.117 2.293-37.367 11.254-10.254 8.9648-16.137 21.914-16.145 35.531 0 42.18 25.191 68.543 71.484 76.281zm211.91 191.37c0 92.699-54.441 141.7-157.44 141.7-103 0-157.44-48.996-157.44-141.7 0-82.492 76.359-188.93 157.44-188.93s157.44 106.44 157.44 188.93zm-236.16-299.14c8.3516 0 16.359 3.3164 22.266 9.2227s9.2227 13.914 9.2227 22.266c0 4.3477 3.5234 7.8711 7.8711 7.8711 4.3477 0 7.875-3.5234 7.875-7.8711 0-11.25 6-21.645 15.742-27.27 9.7422-5.625 21.746-5.625 31.488 0 9.7422 5.625 15.746 16.02 15.746 27.27 0 4.3477 3.5234 7.8711 7.8711 7.8711s7.8711-3.5234 7.8711-7.8711c0-11.25 6-21.645 15.746-27.27 9.7422-5.625 21.742-5.625 31.484 0 9.7461 5.625 15.746 16.02 15.746 27.27 0 46.926-38.266 60.387-74.785 62.59 7.5977-8.582 11.797-19.641 11.809-31.102 0-4.3477-3.5234-7.8711-7.8711-7.8711s-7.8711 3.5234-7.8711 7.8711c0 11.25-6.0039 21.645-15.746 27.27-9.7422 5.625-21.746 5.625-31.488 0-9.7422-5.625-15.742-16.02-15.742-27.27 0-4.3477-3.5273-7.8711-7.875-7.8711-4.3477 0-7.8711 3.5234-7.8711 7.8711 0.011719 11.461 4.2109 22.52 11.809 31.102-36.52-2.2031-74.785-15.664-74.785-62.59 0-8.3516 3.3203-16.359 9.2227-22.266 5.9062-5.9062 13.914-9.2227 22.266-9.2227z"
							></path>
							<path
								d="m588.93 313.41c2.0898 0 4.0898-0.82812 5.5664-2.3047 1.4766-1.4766 2.3086-3.4805 2.3086-5.5664v-7.8711c0-4.3477-3.5273-7.875-7.875-7.875-4.3477 0-7.8711 3.5273-7.8711 7.875v7.8711c0 2.0859 0.82812 4.0898 2.3047 5.5664 1.4766 1.4766 3.4805 2.3047 5.5664 2.3047z"
							></path>
							<path
								d="m588.93 329.15c-4.3477 0-7.8711 3.5273-7.8711 7.875v7.8711c0 4.3477 3.5234 7.8711 7.8711 7.8711 4.3477 0 7.875-3.5234 7.875-7.8711v-7.8711c0-2.0898-0.83203-4.0898-2.3086-5.5664-1.4766-1.4766-3.4766-2.3086-5.5664-2.3086z"
							></path>
							<path
								d="m557.44 321.28c0 2.0898 0.83203 4.0898 2.3086 5.5664 1.4766 1.4766 3.4766 2.3047 5.5664 2.3047h7.8711c4.3477 0 7.8711-3.5234 7.8711-7.8711s-3.5234-7.8711-7.8711-7.8711h-7.8711c-4.3477 0-7.875 3.5234-7.875 7.8711z"
							></path>
							<path
								d="m604.67 329.15h7.8711c4.3477 0 7.8711-3.5234 7.8711-7.8711s-3.5234-7.8711-7.8711-7.8711h-7.8711c-4.3477 0-7.8711 3.5234-7.8711 7.8711s3.5234 7.8711 7.8711 7.8711z"
							></path>
							<path
								d="m211.07 234.69c2.0859 0 4.0898-0.83203 5.5664-2.3086 1.4766-1.4766 2.3047-3.4766 2.3047-5.5664v-7.8711c0-4.3477-3.5234-7.8711-7.8711-7.8711-4.3477 0-7.8711 3.5234-7.8711 7.8711v7.8711c0 2.0898 0.82812 4.0898 2.3047 5.5664 1.4766 1.4766 3.4766 2.3086 5.5664 2.3086z"
							></path>
							<path
								d="m211.07 250.43c-4.3477 0-7.8711 3.5234-7.8711 7.8711v7.875c0 4.3477 3.5234 7.8711 7.8711 7.8711 4.3477 0 7.8711-3.5234 7.8711-7.8711v-7.875c0-2.0859-0.82812-4.0898-2.3047-5.5664-1.4766-1.4766-3.4805-2.3047-5.5664-2.3047z"
							></path>
							<path
								d="m187.45 250.43h7.8711c4.3477 0 7.875-3.5234 7.875-7.8711s-3.5273-7.8711-7.875-7.8711h-7.8711c-4.3477 0-7.8711 3.5234-7.8711 7.8711s3.5234 7.8711 7.8711 7.8711z"
							></path>
							<path
								d="m226.81 250.43h7.875c4.3477 0 7.8711-3.5234 7.8711-7.8711s-3.5234-7.8711-7.8711-7.8711h-7.875c-4.3477 0-7.8711 3.5234-7.8711 7.8711s3.5234 7.8711 7.8711 7.8711z"
							></path>
							<path
								d="m557.44 258.3c2.0898 0 4.0898-0.82812 5.5664-2.3047 1.4766-1.4766 2.3086-3.4766 2.3086-5.5664v-7.8711c0-4.3477-3.5273-7.8711-7.875-7.8711s-7.8711 3.5234-7.8711 7.8711v7.8711c0 2.0898 0.82812 4.0898 2.3047 5.5664 1.4766 1.4766 3.4805 2.3047 5.5664 2.3047z"
							></path>
							<path
								d="m234.69 313.41v7.8711c0 4.3477 3.5234 7.8711 7.8711 7.8711s7.8711-3.5234 7.8711-7.8711v-7.8711c0-4.3477-3.5234-7.8711-7.8711-7.8711s-7.8711 3.5234-7.8711 7.8711z"
							></path>
							<path
								d="m392.12 360.64v16.453c-15.633 2.7383-28.844 13.145-35.172 27.699-6.3242 14.555-4.918 31.316 3.7461 44.613 8.6641 13.297 23.43 21.352 39.301 21.445 8.3516 0 16.359 3.3164 22.266 9.2227 5.9023 5.9023 9.2227 13.914 9.2227 22.266 0 8.3516-3.3203 16.359-9.2227 22.266-5.9062 5.9023-13.914 9.2227-22.266 9.2227s-16.363-3.3203-22.266-9.2227c-5.9062-5.9062-9.2227-13.914-9.2227-22.266 0-4.3477-3.5273-7.875-7.875-7.875-4.3477 0-7.8711 3.5273-7.8711 7.875 0.019531 11.148 3.9844 21.934 11.184 30.449 7.2031 8.5117 17.184 14.207 28.176 16.074v16.453c0 4.3477 3.5273 7.8711 7.875 7.8711s7.8711-3.5234 7.8711-7.8711v-16.453c15.633-2.7383 28.848-13.145 35.172-27.699 6.3242-14.555 4.918-31.316-3.7461-44.613s-23.43-21.352-39.297-21.445c-8.3516 0-16.363-3.3164-22.266-9.2227-5.9062-5.9023-9.2227-13.914-9.2227-22.266 0-8.3516 3.3164-16.359 9.2227-22.266 5.9023-5.9023 13.914-9.2227 22.266-9.2227s16.359 3.3203 22.266 9.2227c5.9023 5.9062 9.2227 13.914 9.2227 22.266 0 4.3477 3.5234 7.875 7.8711 7.875s7.8711-3.5273 7.8711-7.875c-0.019531-11.148-3.9805-21.934-11.184-30.449-7.2031-8.5117-17.184-14.207-28.176-16.074v-16.453c0-4.3477-3.5234-7.8711-7.8711-7.8711s-7.875 3.5234-7.875 7.8711z"
							></path>
						</g>
					</g>
				</svg>
				<div class="money_count">{{ this.coins }}</div>
			</div>
		</div>
		<swiper
			ref="swiperRef"
			@swiper="onSwiperInit"
			:effect="'cards'"
			:grabCursor="true"
			:modules="modules"
			:slideToClickedSlide="true"
			:threshold="1"
			:speed="400"
			:longSwipes="true"
			:longSwipesMs="50"
			:shortSwipes="true"
			:simulateTouch="true"
			class="mySwiper"
		>
			<div
				class="close_icon"
				@click="HidePreview"
				:class="{ hidden: !isPreview }"
			>
				<img src="../assets/Close_icon.svg" alt="" />
			</div>
			<div v-for="picture in updatedPictures" :key="picture.id"></div>
			<div
				class="bye_icon"
				@click="BuyPicture"
				:class="{ hidden: !isPreview || updatedPictures[imgName]?.is_opened }"
			>
				Купить
			</div>

			<div
				class="choose_icon"
				@click="ChoosePicture"
				:class="{ hidden: !isPreview || !updatedPictures[imgName]?.is_opened }"
			>
				Выбрать
			</div>
			<swiper-slide @click="ShowPreview">
				<img
					class="slide_img"
					src="../assets/LoFi_Boy.png"
					alt="LoFi"
					:id="pictures.LoFi.id"
				/>
				<div class="lockdisplay" v-if="!updatedPictures.LoFi.is_opened">
					<img class="lock_icon" src="../assets/Lock_icon.svg" alt="" />
					<div class="lockdisplay_text">
						Стоимость:
						{{ updatedPictures.LoFi.price }} монет
					</div>
				</div>
			</swiper-slide>
			<swiper-slide @click="ShowPreview">
				<img
					class="slide_img"
					src="../assets/Japan.png"
					alt="JapanVibe"
					:id="pictures.JapanVibe.id"
				/>
				<div class="lockdisplay" v-if="!updatedPictures.JapanVibe.is_opened">
					<img class="lock_icon" src="../assets/Lock_icon.svg" alt="" />
					<div class="lockdisplay_text">
						Стоимость:
						{{ updatedPictures.JapanVibe.price }} монет
					</div>
				</div>
			</swiper-slide>
			<swiper-slide @click="ShowPreview"
				><img
					class="slide_img"
					src="../assets/CyberPhunk.png"
					:id="pictures.CyberPhunk.id"
					alt="CyberPhunk"
				/>
				<div class="lockdisplay" v-if="!updatedPictures.CyberPhunk.is_opened">
					<img class="lock_icon" src="../assets/Lock_icon.svg" alt="" />
					<div class="lockdisplay_text">
						Стоимость:
						{{ updatedPictures.CyberPhunk.price }} монет
					</div>
				</div></swiper-slide
			><swiper-slide @click="ShowPreview"
				><img
					class="slide_img"
					src="../assets/SynthWave_Girl.png"
					:id="pictures.SynthWave.id"
					alt="SynthWave"
				/>
				<div class="lockdisplay" v-if="!updatedPictures.SynthWave.is_opened">
					<img class="lock_icon" src="../assets/Lock_icon.svg" alt="" />
					<div class="lockdisplay_text">
						Стоимость:
						{{ updatedPictures.SynthWave.price }} монет
					</div>
				</div>
			</swiper-slide>
		</swiper>
	</div>
</template>

<script>
// Import Swiper Vue.js components
import { Swiper, SwiperSlide } from 'swiper/vue'

// Import Swiper styles
import 'swiper/css'

import 'swiper/css/effect-cards'

// import required modules
import { EffectCards } from 'swiper/modules'
import { ref } from 'vue'

export default {
	name: 'ShopView',
	data() {
		return {
			imgName: '',
			isPreview: false,
			allowTouchMove: true,
			modules: [EffectCards],
			swiperInstance: null,
			coins: 0,
			openedPictures: [1],
			pictures: {
				LoFi: {
					id: 0,
					level_to_open: 0,
					price: 0,
					is_opened: true,
				},
				JapanVibe: {
					id: 1,
					level_to_open: 6,
					price: 300,
					is_opened: false,
				},
				CyberPhunk: {
					id: 2,
					level_to_open: 6,
					price: 1000,
					is_opened: false,
				},
				SynthWave: {
					id: 3,
					level_to_open: 9,
					price: 3500,
					is_opened: false,
				},
			},
		}
	},
	computed: {
		updatedPictures() {
			// создаём новый объект, копируя исходный и меняя is_opened
			const result = {}
			for (const key in this.pictures) {
				// копируем объект, чтобы не мутировать оригинал
				const pic = { ...this.pictures[key] }
				// если id есть в массиве openedPictures, ставим is_opened = true, иначе false
				pic.is_opened = this.openedPictures.includes(pic.id)
				result[key] = pic
			}
			return result
		},
	},
	components: {
		Swiper,
		SwiperSlide,
	},
	setup() {
		return {}
	},
	async mounted() {
		await this.fetchMoneyCnt()
		await this.fetchOpenedPictures()
	},
	methods: {
		async fetchMoneyCnt() {
			try {
				const tg_user = window.Telegram.WebApp.initDataUnsafe?.user
				const response = await fetch(
					`http://127.0.0.1:8080/api/users/${tg_user.id}`
				)
				const data = await response.json()
				this.coins = data.coins
			} catch (error) {
				console.log(error)
			}
		},

		async fetchOpenedPictures() {
			try {
				const tg_user = window.Telegram.WebApp.initDataUnsafe?.user
				const response = await fetch(
					`http://127.0.0.1:8080/api/pictures/opened/${tg_user.id}`
				)
				const data = await response.json()

				this.openedPictures = data.opened_pictures || []

				console.log('Opened pictures IDs:', this.openedPictures)
			} catch (error) {
				console.error('Ошибка получения открытых картинок:', error)
				this.openedPictures = []
			}
		},

		onSwiperInit(swiper) {
			// вызывается сразу после инициализации Swiper
			this.swiperInstance = swiper
		},
		ShowPreview(event) {
			const slide = event.target.closest('.swiper-slide')
			if (!slide) return
			const img = slide.querySelector('.slide_img')
			const imgName = img?.alt
			this.imgName = imgName

			const lock = slide.querySelector('.lockdisplay')
			if (lock) lock.style.transform = 'scale(1.4)'
			if (img) img.style.transform = 'scale(1.4)'

			const swiper = this.swiperInstance
			if (swiper) {
				swiper.params.allowTouchMove = false
				swiper.allowTouchMove = false
				swiper.update()
				this.isPreview = true // Всегда показываем превью
			}
		},
		HidePreview() {
			const swiper = this.swiperInstance
			if (swiper) {
				swiper.params.allowTouchMove = true
				swiper.allowTouchMove = true
				swiper.update()
			}
			document.querySelectorAll('.slide_img').forEach(img => {
				img.style.transform = ''
			})
			document.querySelectorAll('.lockdisplay').forEach(img => {
				img.style.transform = ''
			})
			this.isPreview = false
		},

		async ChoosePicture() {
			const tg_user = window.Telegram.WebApp.initDataUnsafe?.user
			if (!tg_user?.id) return
			const picture = this.pictures[this.imgName]
			try {
				await fetch(`http://127.0.0.1:8080/api/picture/`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						id: picture.id,
						tg_id: tg_user.id,
						level_to_open: picture.level_to_open,
						price: picture.price,
						is_opened: true,
					}),
				})
			} catch (error) {
				console.log(error)
			}
		},

		async BuyPicture() {
			const tg_user = window.Telegram.WebApp.initDataUnsafe?.user
			if (!tg_user?.id) return
			let data = null
			try {
				const response = await fetch(
					`http://127.0.0.1:8080/api/users/${tg_user.id}`
				)
				data = await response.json()
			} catch (error) {
				console.log('Ошибка получения пользователя:', error)
				alert('Не удалось получить информацию о пользователе.')
				return
			}
			const picture = this.pictures[this.imgName]
			if (!picture) {
				alert('Ошибка: картинка не найдена.')
				return
			}
			if (data.coins < picture.price) {
				alert('Не хватает денег')
				return
			}
			data.coins -= picture.price
			try {
				await fetch(`http://127.0.0.1:8080/api/picture/`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						id: picture.id,
						tg_id: tg_user.id,
						level_to_open: picture.level_to_open,
						price: picture.price,
						is_opened: true,
					}),
				})

				await fetch(`http://127.0.0.1:8080/api/users/`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						tg_id: tg_user.id,
						timer: data.timer,
						coins: data.coins,
						experience: data.experience,
						level_cnt: data.level_cnt,
						username: tg_user.username,
					}),
				})

				await fetch(`http://127.0.0.1:8080/api/pictures/opened`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						tg_id: tg_user.id,
						picture_id: picture.id,
					}),
				})

				await this.fetchOpenedPictures() // Обновляем данные
				alert('Картинка успешно куплена!')

				this.HidePreview()
			} catch (error) {
				console.log('Ошибка при покупке:', error)
				alert('Ошибка при попытке покупки.')
			}
		},
	},
}
</script>

<style>
.shop_icon_container {
	display: flex;
	align-self: center;
	justify-content: center;
	margin-top: 35px;
}

.shop_icon {
	width: 60px;
	height: 60px;
}
.swiper {
	width: 240px;
	height: 320px;
	margin-top: 86px;
}

.swiper-slide {
	display: flex;
	align-items: center;
	justify-content: center;
	border-radius: 18px;
	overflow: visible !important;
}

.slide_img {
	width: 240px;
	height: 320px;
	transition: transform 0.2s ease;
	border-radius: 18px;
}

.close_icon {
	position: absolute;
	top: -80px;
	right: -60px;
	cursor: pointer;
	z-index: 999;
}

.money_container {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	position: absolute;
	right: 100px;
}

.money_count {
	color: #fff;
	margin-top: 8px;
}

.bye_icon {
	position: absolute;
	top: 390px;
	left: 20px;
	cursor: pointer;
	width: 200px;
	height: 30px;
	background-color: #fff;
	display: flex;
	align-items: center;
	justify-content: center;
	z-index: 999;
	border-radius: 24px;
	transition: transform 0.2s ease;
}
.choose_icon {
	position: absolute;
	top: 390px;
	left: 20px;
	cursor: pointer;
	width: 200px;
	height: 30px;
	display: flex;
	align-items: center;
	justify-content: center;
	z-index: 999;
	border-radius: 24px;
	transition: transform 0.2s ease;
	background-color: #4caf50; /* Зеленый для кнопки выбора */
	color: white;
}

.close_icon.hidden {
	display: none;
}

.bye_icon.hidden {
	display: none;
}
.bye_icon:active {
	transform: scale(1.1);
}

.choose_icon:active {
	transform: scale(1.1);
}
.choose_icon.hidden {
	display: none;
}

.slide_img {
	width: 240px;
	height: 320px;
	transition: transform 0.2s ease;
	border-radius: 18px;
}

.lockdisplay {
	position: absolute;
	width: 240px;
	height: 320px;
	background: #0f0f0f;
	border-radius: 18px;
	opacity: 0.8;
	transition: transform 0.2s ease;
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
}

.lockdisplay_text {
	color: #6e6b6b;
	margin-top: 8px;
	text-align: center;
}

.lockdisplay.hidden {
	display: none;
}

.lock_icon {
	z-index: 999;
}
</style>
